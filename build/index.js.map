{"version":3,"file":"index.js","sources":["../source/index.ts"],"sourcesContent":["import { createServer, Server, IncomingMessage, ServerResponse } from 'http';\nimport vamtigerRequire, { Params as RequireParams } from 'vamtiger-require';\nimport { ReferenceObjectPath } from 'vamtiger-reference-object-path';\nimport Argv = require('vamtiger-argv');\n\nconst referenceObjectPath = require('vamtiger-reference-object-path') as ReferenceObjectPath;\n\nlet server: Server;\n\nexport default function vamtigerDebugServer({ port }: Params) {\n    server = !server ? createServer(handleRequest) : server;\n\n    server.listen(port);\n\n    return server;\n}\n\nexport function stopServer() {\n    server.close();\n}\n\nasync function handleRequest(request: IncomingMessage, response: ServerResponse) {\n    const body = await getBody({ request });\n    const callback = (error: Error, result: any) => response.end(JSON.stringify({ error, result }));\n\n    let result;\n\n    response.setHeader(HeaderKey.contentType, HeaderValue.json);\n\n    try {\n        if (body.callback) {\n            body.arguments && body.arguments.push(callback);\n            body.instanceArguments && body.instanceArguments.push(callback);\n\n            result = vamtigerRequire(body);\n        } else {\n            result = vamtigerRequire(body);\n\n            if (body.instanceGetPath)\n                result = referenceObjectPath({\n                    object: result,\n                    path: body.instanceGetPath\n                });\n\n            response.end(JSON.stringify({ result }));\n        }\n    } catch(error){\n        console.error(error);\n\n        response.end(JSON.stringify({ error }));\n    };\n}\n\nfunction getBody({ request }: GetBodyParams): Promise<Body> {\n    const body = [] as Uint8Array[];\n\n    return new Promise(resolve => {\n        request.on(\n            Event.data,\n            chuck => body.push(chuck)\n        );\n        request.on(\n            Event.end,\n            () => Promise\n                .resolve(Buffer.concat(body).toString())\n                .then(JSON.parse)\n                .then(resolve)\n        )\n    })\n}\n\nexport interface Params {\n    port: string | number;\n}\n\nexport interface GetBodyParams {\n    request: IncomingMessage\n}\n\nexport interface Body extends RequireParams {\n    callback?: boolean;\n    instanceGetPath?: string;\n}\n\nexport enum Event {\n    data = 'data',\n    end = 'end'\n}\n\nexport enum HeaderKey {\n    contentType = 'Content-Type'\n}\n\nexport enum HeaderValue {\n    json = 'application/json'\n}\n\nexport enum CommandlineArgs {\n    port = 'port'\n}\n\nexport type VamtigerDebugServer = typeof vamtigerDebugServer;"],"names":["referenceObjectPath","require","server","vamtigerDebugServer","port","createServer","handleRequest","listen","stopServer","close","request","response","body","getBody","callback","error","result","end","JSON","stringify","setHeader","HeaderKey","contentType","HeaderValue","json","arguments","push","instanceArguments","vamtigerRequire","instanceGetPath","object","path","console","Promise","resolve","on","Event","data","chuck","Buffer","concat","toString","then","parse","CommandlineArgs"],"mappings":"sfAKA,MAAMA,oBAAsBC,QAAQ,kCAEpC,IAAIC,OAEJ,SAAwBC,qBAAoBC,KAAEA,IAK1C,OAJAF,OAAUA,QAASG,kBAAaC,gBAEzBC,OAAOH,GAEPF,OAGX,SAAgBM,aACZN,OAAOO,QAGX,SAAeH,cAAcI,EAA0BC,mDACnD,MAAMC,QAAaC,SAAUH,QAAAA,IACvBI,EAAW,CAACC,EAAcC,IAAgBL,EAASM,IAAIC,KAAKC,WAAYJ,MAAAA,EAAOC,OAAAA,KAErF,IAAIA,EAEJL,EAASS,UAAUC,kBAAUC,YAAaC,oBAAYC,MAEtD,IACQZ,EAAKE,UACLF,EAAKa,WAAab,EAAKa,UAAUC,KAAKZ,GACtCF,EAAKe,mBAAqBf,EAAKe,kBAAkBD,KAAKZ,GAEtDE,EAASY,gBAAgBhB,KAEzBI,EAASY,gBAAgBhB,GAErBA,EAAKiB,kBACLb,EAAShB,qBACL8B,OAAQd,EACRe,KAAMnB,EAAKiB,mBAGnBlB,EAASM,IAAIC,KAAKC,WAAYH,OAAAA,MAEpC,MAAMD,GACJiB,QAAQjB,MAAMA,GAEdJ,EAASM,IAAIC,KAAKC,WAAYJ,MAAAA,QAItC,SAASF,SAAQH,QAAEA,IACf,MAAME,KAEN,OAAO,IAAIqB,QAAQC,IACfxB,EAAQyB,GACJC,cAAMC,KACNC,GAAS1B,EAAKc,KAAKY,IAEvB5B,EAAQyB,GACJC,cAAMnB,IACN,IAAMgB,QACDC,QAAQK,OAAOC,OAAO5B,GAAM6B,YAC5BC,KAAKxB,KAAKyB,OACVD,KAAKR,OAkBtB,SAAYE,GACRA,cACAA,YAFJ,CAAYA,gBAAAA,oBAKAf,oBAAAA,mDAIAE,sBAAAA,kDAIAqB,0BAAAA"}